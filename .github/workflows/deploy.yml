name: Deploy Frontend to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          debug: true
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -ex

            echo "ðŸ‘¤ User:"
            whoami

            # ðŸ”¥ LOAD NVM (MOST IMPORTANT PART)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            echo "ðŸ”Ž Node info:"
            node -v
            npm -v
            pm2 -v

            cd /var/www/carefoundation/frontend

            echo "ðŸ“‚ Current directory:"
            pwd

            echo "ðŸ”„ Fetching latest code..."
            git fetch origin
            git reset --hard origin/main

            echo "ðŸ“¦ Installing dependencies..."
            npm install

            echo "ðŸ—ï¸ Building Next.js app..."
            npm run build

            echo "âœ… Verifying build output..."
            # Check for Next.js build output
            if [ -d ".next" ]; then
              echo "âœ… .next directory exists"
              if [ -d ".next/static" ]; then
                echo "âœ… Static assets directory exists"
                echo "ðŸ“¦ Static files:"
                find .next/static -type f | head -10
              else
                echo "âš ï¸ Warning: .next/static directory not found!"
              fi
              if [ -d ".next/static/css" ]; then
                echo "âœ… CSS files generated successfully"
                ls -la .next/static/css/ | head -5
              else
                echo "âš ï¸ Warning: CSS directory not found!"
              fi
            else
              echo "âŒ ERROR: .next directory not found! Build failed!"
              exit 1
            fi

            echo "ðŸš€ Restarting PM2 process..."
            # Check if process exists, restart or start accordingly
            if pm2 describe care_frontend > /dev/null 2>&1; then
              echo "âœ… Process exists - Restarting..."
              pm2 restart care_frontend
            else
              echo "ðŸ†• Process doesn't exist - Starting new..."
              # Start PM2 with Next.js production server
              # Using 'next start' directly ensures proper static asset serving
              pm2 start npm --name care_frontend -- start -- --port 3000
            fi

            echo "ðŸ’¾ Saving PM2 configuration..."
            pm2 save

            echo "ðŸ“Š PM2 Status:"
            pm2 status

            echo "âœ… Deployment completed successfully!"
